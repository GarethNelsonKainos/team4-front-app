name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
     - uses: actions/checkout@v5
    
     - name: Setup Node.js
       uses: actions/setup-node@v4
       with:
         node-version: '20'
         cache: 'npm'
    
     - name: Install dependencies
       run: npm ci
    
     - name: Run Biome checks
       run: npm run ci:check
    
     - name: Build TypeScript
       run: npm run build
    
     - name: Build CSS (Production)
       run: npm run build-css-prod
    
     - name: Run tests with coverage
       run: npm run test:coverage

     - name: Upload coverage to Coverage report folder
       uses: actions/upload-artifact@v4
       with:
         name: coverage-report
         path: output/test/

     - name: Install Pa11y CI
       run: npm install -g pa11y-ci pa11y-runner-axe pa11y-runner-htmlcs

     - name: Create accessibility reports directory
       run: mkdir -p output/accessibility

     - name: Start application server
       run: |
         npm run dev &
         echo $! > server.pid
         sleep 10

     - name: Wait for server to be ready
       run: |
         timeout 30 bash -c 'until curl -f http://localhost:3000; do sleep 2; done'

     - name: Run Pa11y accessibility tests
       continue-on-error: true
       run: |
         pa11y-ci --json > output/accessibility/pa11y-results.json 2>&1 || true
         pa11y-ci

     - name: Generate HTML accessibility report
       if: always()
       run: node generate-a11y-report.js output/accessibility/pa11y-results.json

     - name: Upload accessibility report
       if: always()
       uses: actions/upload-artifact@v4
       with:
         name: accessibility-report
         path: output/accessibility/

     - name: Stop server
       if: always()
       run: |
         if [ -f server.pid ]; then
           kill $(cat server.pid) || true
         fi